% Using knitr and pandoc to create dynamic documents
% Peter Humburg
% `r format(Sys.time(), "%a %b %d %Y")`


```{r setup, echo = FALSE}
require(knitr)
hook_source_def = knit_hooks$get('source')
knit_hooks$set(source = function(x, options){
  if (!is.null(options$verbatim) && options$verbatim){
    opts = gsub(",\\s*verbatim\\s*=\\s*TRUE\\s*", "", options$params.src)
    bef = sprintf('\n\n    ```{r %s}\n', opts, "\n")
    stringr::str_c(bef, paste(knitr:::indent_block(x, "    "), collapse = '\n'), "\n    ```\n")
  } else {
     hook_source_def(x, options)
  }
})

rinline <- function(code){
	sprintf('`r %s`', code)
}
```

# Introduction
This is an introduction to the use of [Markdown](http://daringfireball.net/projects/markdown/)
with embedded R code to create dynamic documents in multiple formats, 
e.g. HTML, PDF and Word. This is useful to generate reports (or papers) that contain all
the relevant R code to carry out the analysis and allows for automatic updates to the 
document if either the code or the data change. As a result analyses become a lot 
easier to reproduce because the code and the presentation of results are closely 
linked and figures and tables can be updated automatically.

Several tools are available to do this but here we will mainly focus on a combination
of two of these.

[`knitr`](http://yihui.name/knitr/)
:   This R package provides functions that allow the processing of Markdown documents
    with embedded R code. The code will be executed and its output, including plots,
    can be included in the output.
[`pandoc`](http://johnmacfarlane.net/pandoc/)
:   This is a versatile tool that supports conversion between a large number of input
    and output formats. We will use 
    [pandoc's own Markdown flavour](http://johnmacfarlane.net/pandoc/demo/example9/pandocs-markdown.html)
    (which includes numerous extension to the original format) as input and use its 
    conversion capabilities to obtain output in several commonly used formats.  

Throughout this document examples of R code and Markdown formatting will be presented in 
code blocks:
```r
message("This is R code")
```

To better show the effect of Markdown examples on the output these will often be
followed by the same text rendered in the output format. To distinguish these examples
from the main text the entire block of raw and converted Markdown will be framed by
horizontal lines. 

----

```markdown
This is Markdown text in **bold** and *italics*.
```

This is Markdown text in **bold** and *italics*.

----

In addition to the code examples provided throughout this document the document itself is
written in Markdown with embedded R code and may illustrate additional features.

# Brief Markdown primer
A Markdown formatted file is in essence a plain text file that may contain a number of
formatting marks. It is designed to be easy to write and read in its raw form. Although
it was originally designed as an easier way to write web pages it can be converted to
many other rich text formats.  

The purpose of this section is to briefly describe basic elements of Markdown formatting.
More detailed descriptions are available online, e.g. at the official
[Markdown](http://daringfireball.net/projects/markdown/syntax) and
[`pandoc`](http://johnmacfarlane.net/pandoc/README.html) websites.

## Headers, paragraphs and emphasis
The basics of text formatting involve marking of text as headings, structuring 
it into paragraphs and highlighting selected words for emphasis. Headings can be
created by underlining them:

```markdown
This is a top level heading
===========================
This is some ordinary text.

This is a second level heading
------------------------------
It is followed by more ordinary text.

### Third level heading
Adding more "#" creates lower level headings
```

Note that `pandoc` also allows the use of "#" and "##" for first and second level headings. 

Paragraphs are created by adding an empty line between two lines of text:

----

```markdown
This is the first paragraph.
Line breaks are generally ignored in formatting.

This is the second paragraph.
If you add two or more spaces to the end of a line  
the line break will be preserved in the conversion
to the output format.  
```

This is the first paragraph.
Line breaks are generally ignored in formatting.

This is the second paragraph.
If you add two or more spaces to the end of a line  
the line break will be preserved in the conversion
to the output format.

----

Several methods of highlighting text are supported:

----

```markdown
Words within a paragraph and be *emphasised*. These are usually rendered in *italics*.
**Strong emphasis** typically results in **bold** text. Instead of * it is also possible
to use _ for emphasis. With pandoc it is also possible to ~~strike out~~ text.
```

Words within a paragraph and be *emphasised*. These are usually rendered in *italics*.
**Strong emphasis** typically results in **bold** text. Instead of * it is also possible
to use _ for emphasis. With pandoc it is also possible to ~~strike out~~ text.

----

## Block elements

### Block quotes
In Markdown quotes can be marked using the same conventions commonly used in email:

----

```markdown
 > This text is quoted. A single ">" at the beginning
 > of the paragraph is sufficient for the entire paragraph 
 > to be quoted (but syntax highlighting may not work properly).
 > 
 > > You can also quote other quotes, i.e. block quotes can be nested.
```
 
 > This text is quoted. A single ">" at the beginning
 > of the paragraph is sufficient for the entire paragraph 
 > to be quoted (but syntax highlighting may not work properly).
 > 
 > > You can also quote other quotes, i.e. block quotes can be nested.

----

### Lists
Basic bullet lists can be created by starting a line with a \*:

----

```markdown
 * first item
 * second item
 * third item
```
 
 * first item
 * second item
 * third item

----

Ordered lists start with numbers

----

```markdown
1. first item
2. second item
3. third item
```

1. first item
2. second item
3. third item

----

but `pandoc` also allows this:

----

```markdown
#. first item
#. second item
#. third item
```

#. first item
#. second item
#. third item

----


There is support for other of list types and variations of the basic syntax
in `pandoc`. See the [documentation](http://johnmacfarlane.net/pandoc/README.html#lists)
for more details. 

### Tables
Basic Markdown tables are created by lining up the columns and making headers, like so:

----

```markdown
 Column 1    Column 2    Column 3
 --------    --------    --------
   1            10         100
   2            20         200
   3            30         300
  
 Table: A simple table 
```


  Column 1      Column 2      Column 3
 ----------    ----------    ----------
   1              10            100
   2              20            200
   3              30            300
  
 Table: A simple table 

----

Just as with lists there are several variations and extensions to this basic syntax
supported by `pandoc`. As usual, details can be found in the
[documentation](http://johnmacfarlane.net/pandoc/README.html#tables).

### Code blocks and inline code
Special blocks to display source code with syntax highlighting can be included by starting
a line with three back ticks, optionally followed by attributes to control aspects of
the highlighting. A block like the one below will be rendered as R code.

----

````
```r
x <- seq(-6,6, by=0.1)
yNorm <- dnorm(x)
yt <- dt(x, df=3)
yCauchy <- dcauchy(x)
plot(x, yNorm, type="l", ylab="Density")
lines(x, yt, col=2)
lines(x, yCauchy, col=4)
legend("topright", legend=c("standard normal", "t (df=2)", "Cauchy"), 
    col=c(1,2,4), lty=1)
```
````

```r
x <- seq(-6,6, by=0.1)
yNorm <- dnorm(x)
yt <- dt(x, df=3)
yCauchy <- dcauchy(x)
plot(x, yNorm, type="l", ylab="Density")
lines(x, yt, col=2)
lines(x, yCauchy, col=4)
legend("topright", legend=c("standard normal", "t (df=2)", "Cauchy"), 
    col=c(1,2,4), lty=1)
```

----

Code fragments can also be included inline:

----

```markdown
This is normal text with some R code: `x <- runif(100)`{.r}.
```
This is normal text with some R code: `x <- runif(100)`{.r}.

----

# Using `knitr` for dynamic code blocks
The code blocks we have seen so far are all static, i.e. while they do include
valid source code this code is not interpreted, just displayed. To achieve the aim of
a dynamic document that can be updated automatically if the underlying data or analysis
change we need code blocks that are actually executed. The `knitr` R package does just 
that. Lets look again at the R code from the example in the previous section but this 
time we will use a code block that `knitr` will process. 

````
```{r distributions, verbatim = TRUE}
x <- seq(-6,6, by=0.1)
yNorm <- dnorm(x)
yt <- dt(x, df=3)
yCauchy <- dcauchy(x)
```
````

In this example syntac highlighting for the R code has been switched off
to better demonstrate how the code chunks are created. Once the code in the above
block has been evaluated we can use it for inline R statements that will be
replaced with the computed values. For example we can do something like this:

----

```markdown
The Normal density was evaluated at `r rinline("length(yNorm)")` points.
```

The Normal density was evaluated at `r length(yNorm)` points.

----

## Figures
To add a figure with a plot of the data all that is needed is to create the
plot in an R chunk.

```{r distribution_plot, fig.cap="Three related distributions"}
plot(x, yNorm, type="l", ylab="Density")
lines(x, yt, col=2)
lines(x, yCauchy, col=4)
legend("topright", legend=c("standard normal", "t (df=3)", "Cauchy"), 
   col=c(1,2,4), lty=1)
```

This automatically includes the plot that was generated as a figure in the
final document. It is possible to include a custom caption using the chunk option
`fig.cap`.

## Animations
It is possible to include animations (generated from a series of plots) instead of 
a single figure. Look at this slightly more complex version of the previous example:

```{r distributions2, fig.show="animate", fig.cap="Movie of three related distributions"}
x <- seq(-6,6, by=0.1)
yNorm <- dnorm(x)
yCauchy <- dcauchy(x)
par(bg="white")
for(i in 1:20){
    plot(x, yNorm, type="l", ylab="Density")
    lines(x, dt(x, df=i), col=2)
    lines(x, yCauchy, col=4)
    legend("topright", legend=c("standard normal", paste0("t (df = ", i, ")"), "Cauchy"), 
       col=c(1,2,4), lty=1)
}
```

It is possible to generate an animated GIF from this sequence of plots by wrapping the
above code in a function and then calling `saveGIF` from the animation package.

```{r distributions3, results="hide"}
threeDists <- function(df, x=seq(-6,6, by=0.1)){
    yNorm <- dnorm(x)
    yCauchy <- dcauchy(x)
    yt <- dt(x, df=df)
    par(bg="white")
    plot(x, yNorm, type="l", ylab="Density")
    lines(x, yt, col=2)
    lines(x, yCauchy, col=4)
    legend("topright", legend=c("standard normal", paste0("t (df = ", df, ")"), "Cauchy"), 
       col=c(1,2,4), lty=1)
}

plotFun <- function(df){
    threeDists(df)
    animation::ani.pause()
}

animation::saveGIF(lapply(1:20, plotFun), interval=0.5, movie.name="dist3.gif")
```

Since the graphics output of this code is written directly to a file rather than an on-screen
graphics device it will not outomatically included in the Markdown document produced 
by `knitr`. It can be included manually using the Markdown syntax for the inclusion
of figures.

```markdown
![Animated GIF of three related distributions](dist3) 
```
![Animated GIF of three related distributions](dist3)

Note that this only works for output document formats that support GIFs. As a fallback
we generate a png of the first frame to be included in other formats, e.g. PDF, that
can't display GIFs.

```{r dist3-png, results="hide"}
png("dist3.png")
threeDists(1)
dev.off()
```

Here we make use of `pandoc`'s `--default-image-extension` option to set the daefault
image format to gif for HTML and docx output and to png for PDF.

## Tables
It is often convenient to display the contents of R objects in the final document.
While it is easy to simply display the output of R's `print` statement as it would
be displayed in the R console, this is not exactly producing pretty results. It
is much more elegant to include proper tables that can be rendered nicely in
the final document. Manually  formatting the output as a Markdown table (that pandoc
will then convert to the final output format) can be a daunting task. Fortunately
R functions exist to help with this task. The `knitr` package provides a simple function, 
`kable`, that allows automatic formatting of tables. This requires the data to be in a 
suitable format (either a `data.frame` or a `matrix`) so some preprocessing may be necessary.

```{r iris1, results="asis"}
data(iris)
knitr::kable(head(iris))
```

A table of summary statistics can be obtained with a little extra effort:
```{r iris2}
irisSummary <- apply(iris[,1:4], 2, function(x) tapply(x, iris$Species, summary))
irisSummary <- lapply(irisSummary, do.call, what=rbind)
```

This produces a list of matrices with summary statistics by iris species:

```{r iris3}
irisSummary
```

Each of these can again be displayed as a nicely formatted table using `kable`
but unfortunately information about the column that was summarised will be lost
in the process. For some output formats `kable` supports the use of a `caption`
option but unfortuantely this doesn't work when producing Markdown, as is the
case here. An alternative is to use the `pander` package to produce output
suitable for further processing with pandoc.

```{r iris4, results="asis"}
suppressPackageStartupMessages(library(pander))
panderOptions('table.split.table', Inf) ## don't split tables
pander(irisSummary[1:2])
```

Alternatively the following code produces somewhat more elegant output at
the expense of a few extra lines of code.

```{r iris5, results="asis"}
for(i in 3:4){
    set.caption(sub(".", " ", names(irisSummary)[i], fixed=TRUE))
    pander(irisSummary[[i]])
}
```

The functionality provided by `pander` is alot more poweful than the simple `kable`
function and can handle a wide variety of R objects.

# Converting from Markdown to multiple output formats using `knitr`


# Preparing manuscripts for publication


## Requirements


## Document meta information


## Better figure and table captions


## Adding a bibliography


## Equations

# Apendix
## Session info
```{r session-info, echo=FALSE, results="asis"}
sessionInfo()
```

